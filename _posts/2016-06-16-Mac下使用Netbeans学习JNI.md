---
layout: post
title:  "Mac下使用NetBeans学习JNI"
date:   2016-06-16 07:51:00 +0800
category: Java学习
tags: [Java, JNI, NetBeans]
---

Java具有良好的扩展性，它能够通过JNI（Java Native Interface）调用系统原生功能、与其它语言进行交互或者在程序中嵌入Java虚拟机等。本文帮助大家在Mac下使用NetBeans创建一个使用JNI调用C语言函数的工程。

### 工具

下面是本文中所使用的工具。

| 工具              | 版本    |
| --------------- | ----- |
| NetBeans IDE    | 8.1   |
| JDK             | 8     |
| OS X SDK（clang） | 10.11 |

其中NetBeans IDE选择了支持C/C++的完整版本，这样虽然所占空间大一些，但是能够兼顾Java、C/C++和HTML 5的开发，在目前的项目实践中更加方便。

> 如果安装的是其它版本，可以通过“**工具 > 插件**”安装所需的插件。

## Java部分

使用JNI的应用程序包含两部分内容：

- Java部分，其中包括调用其它语言（C/C++）代码的Java类。
- C/C++部分，使用JNI封装的动态链接库。

### 创建Java项目

NetBeans作为“Java官方”的编辑器，创建Java项目的过程非常简单。

1 . 选择“**文件 > 新建项目**”，并选择**Java应用程序**类型，选择**下一步**。

![](/image/select_java_app.png)

2 . 输入项目名称**HelloWorld**，并选择合适的位置存储。默认勾选**创建主类**：helloworld.HelloWorld，点击**完成**。

![](/image/input_app_name.png)

接下来在Java项目中增加调用本地代码（C/C++）的内容。

### 调用本地代码

为了简单起见，直接在默认生成的Java类**helloworld.HelloWorld**中增加一个调用本地代码的方法。

1 . 双击**HelloWorld.java**打开文件。每一个Java程序中有且只有一个类包含**main**函数作为程序的入口。

```java
package helloworld;
public class HelloWorld {
  public static void main(String[] args) {
  }
}
```

2 . 在**main**函数中增加一行调用本地代码。

```java
package helloworld;
public class HelloWorld {
  public static void main(String[] args) {
  	HelloWorld hello = new HelloWorld();
    hello.callNative();
  }
}
```

NetBeans会提示`callNative`方法不存在，并且在左侧的**行号**中出现一个**黄色小灯泡**。点击小灯泡会弹出**在`helloworld.HelloWorld`中创建`callNative()`方法**的菜单，选中后自动在`HelloWorld`中创建`callNative`方法。

> NetBeans中可以直接按快捷键**Alt + Enter**弹出菜单。

```java
package helloworld;
public class HelloWorld {
  public static void main(String[] args) {
  	HelloWorld hello = new HelloWorld();
    hello.callNative();
  }
  
  private void nativePrint() {
  	throw new UnsupportedOperationException("Not supported yet."); 
  }
}
```

3 . `nativePrint()`是C/C++函数，因此不需要在Java代码中实现，但是必须使用**`native`**关键字进行标识。

```java
package helloworld;
public class HelloWorld {
  public static void main(String[] args) {
  	HelloWorld hello = new HelloWorld();
    hello.callNative();
  }
  
  private native void callNative();
}
```

4 . 右击**HelloWorld**项目并选择**清理并构建**编译Java项目。这样做会在**NetBeansProjects/HelloWorld/build/classes**目录下生成编译好的Class文件。

### 导出本地代码头文件

上一节提到的本地方法`callNative`是使用其它语言（C/C++）实现的。不同语言的方法（函数）定义格式不同，因此需要创建C/C++所使用的对应函数声明。C/C++一般在头文件中声明函数，因此JDK提供了一个叫**javah**的工具帮助从**Class文件**中自动生成本地方法的头文件。

1 . 打开**终端**（Terminal），跳转到Java项目所在目录。

2 . 使用如下命令生成头文件。

```java
javah -o JNIDemoJava.h -classpath HelloWorld/build/classes helloworld.HelloWorld
```

> 其中**JNIDemoJava.h**为生成的头文件名，**helloworld.HelloWorld**为使用了本地代码的Java类。

**JNIDemoJava.h**的内容如下。

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class helloworld_HelloWorld */

#ifndef _Included_helloworld_HelloWorld
#define _Included_helloworld_HelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     helloworld_HelloWorld
 * Method:    callNative
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_helloworld_HelloWorld_callNative
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

头文件里的就是需要实现的C函数原型。接下来完成项目的C/C++部分。

### 创建C/C++动态库

安装了C/C++插件后，可以直接像创建Java应用一样创建C/C++项目。

1 . 选择**文件 > 新建项目**，并创建**C/C++动态库**。

![](/image/select_c_dynamic.png)

2 . 输入动态库名称。

![](/image/input_c_dynamic_name.png)

3 . 将上一节创建的**JNIDemoJava.h**头文件移动到该项目中。

4 . 在NetBeans中选中**JNIDemo**项目下的**头文件**部分，右击选择**添加现有项**。

![](/image/add_exists_JNI_header.png)

> 存储为**绝对路径**会导致项目移动后出现找不到文件的问题，因此可以选择存储为相对路径。

5 . 新建C语言源文件实现**JNIDemoJava.h**中声明的函数。

```c
#include <jni.h>
#include <stdio.h>
#include "JNIDemoJava.h"

JNIEXPORT void JNICALL Java_helloworld_HelloWorld_callNative
  (JNIEnv *env, jobject obj)
{
    printf("Hello World from C\n");
}
```

### 配置动态库项目

包含的头文件路径。由于C语言源码中包含了`jni.h`头文件，但是默认并没有存在于编译器的查找路径中，因此需要手动进行设置。

1 . 选择**JNIDemo**项目，然后右击弹出菜单，并选择最下面的**属性**项。

2 . 选择**构建**类别下的**C编译器**，并设置**包含目录**。

![](/image/property_include_path.png)

![](/image/include_path.png)

Mac下安装的JDK，默认存放在**/Library/Java/JavaVirtualMachine**下，可以在终端使用一下命令查看。

```bash
$ java -version
java version "1.8.0_92"
$ /usr/libexec/java_home -v 1.8
/Library/Java/JavaVirtualMachines/jdk1.8.0_92.jdk/Contents/Home
```

3 . 设置动态库的输出路径。NetBeans默认根据编译选项（Debug/Release）将编译结果存放在不同的路径下。为了方便在Java项目中使用该动态库，可以设置一个自定义的路径。在“**属性 > 链接器**”的输出选项中设置路径。

```bash
dist/libJNIDemo.${CND_DLIB_EXT}
```

![](/image/linker_output_path.png)

### Java代码加载动态库

Java程序运行时调用本地方法，还有最后一步，就是加载动态库。在`HelloWorld`类中加入一下初始化代码。

```java
package helloworld;

public class HelloWorld {

  //加载动态库
  static {	
    System.load("/Users/apple/NetBeansProjects/JNIDemo/dist/libJNIDemo.dylib");
  }
    
  public static void main(String[] args) {
    new HelloWorld().nativePrint();
  }
  
  private native void nativePrint();
}
```

### 运行Java项目

选择Java项目，点击运行按钮就可以看到程序的最终结果。

```bash
run:
Hello World from C
成功构建 (总时间: 0 秒)
```

### 参考资料

1. [Beginning JNI with NetBeans IDE and C/C++ Plugin on Linux](https://netbeans.org/kb/docs/cnd/beginning-jni-linux.html)